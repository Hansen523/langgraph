# å¦‚ä½•ç­‰å¾…ç”¨æˆ·è¾“å…¥

äººæœºäº¤äº’çš„ä¸»è¦æ¨¡å¼ä¹‹ä¸€æ˜¯ç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚ä¸€ä¸ªå…³é”®ç”¨ä¾‹æ˜¯å‘ç”¨æˆ·æå‡ºæ¾„æ¸…é—®é¢˜ã€‚å®ç°è¿™ä¸€ç‚¹çš„ä¸€ç§æ–¹æ³•æ˜¯ç›´æ¥è½¬åˆ°`END`èŠ‚ç‚¹å¹¶é€€å‡ºå›¾ã€‚ç„¶åï¼Œä»»ä½•ç”¨æˆ·å“åº”éƒ½ä¼šä½œä¸ºå›¾çš„æ–°è°ƒç”¨è¿”å›ã€‚è¿™åŸºæœ¬ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªèŠå¤©æœºå™¨äººæ¶æ„ã€‚

è¿™æ ·åšçš„é—®é¢˜æ˜¯å¾ˆéš¾å›åˆ°å›¾ä¸­çš„ç‰¹å®šç‚¹ç»§ç»­æ‰§è¡Œã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä»£ç†æ­£åœ¨æ‰§è¡ŒæŸä¸ªè¿‡ç¨‹çš„ä¸­é—´é˜¶æ®µï¼Œåªéœ€è¦ä¸€ç‚¹ç”¨æˆ·è¾“å…¥ã€‚è™½ç„¶å¯ä»¥è®¾è®¡å›¾ï¼Œä½¿å…¶å…·æœ‰`conditional_entry_point`ï¼Œå°†ç”¨æˆ·æ¶ˆæ¯è·¯ç”±å›æ­£ç¡®çš„ä½ç½®ï¼Œä½†è¿™å¹¶ä¸å…·æœ‰å¾ˆå¥½çš„æ‰©å±•æ€§ï¼ˆå› ä¸ºè¿™æœ¬è´¨ä¸Šæ¶‰åŠä¸€ä¸ªå¯ä»¥å‡ ä¹åœ¨ä»»ä½•åœ°æ–¹ç»“æŸçš„è·¯ç”±å‡½æ•°ï¼‰ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯è®¾ç½®ä¸€ä¸ªä¸“é—¨ç”¨äºè·å–ç”¨æˆ·è¾“å…¥çš„èŠ‚ç‚¹ã€‚è¿™åœ¨ç¬”è®°æœ¬ç¯å¢ƒä¸­å¾ˆå®¹æ˜“å®ç°â€”â€”åªéœ€åœ¨èŠ‚ç‚¹ä¸­æ”¾ç½®ä¸€ä¸ª`input()`è°ƒç”¨ã€‚ä½†è¿™å¹¶ä¸å®Œå…¨é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚

å¹¸è¿çš„æ˜¯ï¼ŒLangGraphä½¿å¾—å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚åŸºæœ¬æ€è·¯æ˜¯ï¼š

- è®¾ç½®ä¸€ä¸ªè¡¨ç¤ºç”¨æˆ·è¾“å…¥çš„èŠ‚ç‚¹ã€‚è¿™å¯ä»¥æœ‰ç‰¹å®šçš„å…¥è¾¹/å‡ºè¾¹ï¼ˆæ ¹æ®éœ€è¦ï¼‰ã€‚è¯¥èŠ‚ç‚¹ä¸­å®é™…ä¸Šä¸åº”åŒ…å«ä»»ä½•é€»è¾‘ã€‚
- åœ¨è¯¥èŠ‚ç‚¹ä¹‹å‰æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ã€‚è¿™å°†åœ¨è¯¥èŠ‚ç‚¹æ‰§è¡Œä¹‹å‰åœæ­¢å›¾ï¼ˆè¿™å¾ˆå¥½ï¼Œå› ä¸ºå…¶ä¸­æ²¡æœ‰ä»»ä½•å®é™…é€»è¾‘ï¼‰ã€‚
- ä½¿ç”¨`.update_state`æ¥æ›´æ–°å›¾çš„çŠ¶æ€ã€‚ä¼ å…¥ä½ è·å¾—çš„ä»»ä½•ç”¨æˆ·å“åº”ã€‚è¿™é‡Œçš„å…³é”®æ˜¯ä½¿ç”¨`as_node`å‚æ•°ï¼Œ**å°†è¯¥æ›´æ–°åº”ç”¨ä¸ºè¯¥èŠ‚ç‚¹çš„æ“ä½œ**ã€‚è¿™å°†ä½¿å¾—ä¸‹æ¬¡æ¢å¤æ‰§è¡Œæ—¶ï¼Œä»è¯¥èŠ‚ç‚¹åˆšåˆšæ‰§è¡Œåçš„çŠ¶æ€ç»§ç»­ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹ã€‚

## è®¾ç½®

æˆ‘ä»¬ä¸ä¼šå±•ç¤ºæˆ‘ä»¬æ‰˜ç®¡çš„å›¾çš„å®Œæ•´ä»£ç ï¼Œä½†ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹[here](../../how-tos/human_in_the_loop/wait-user-input.ipynb#agent)ã€‚ä¸€æ—¦è¿™ä¸ªå›¾è¢«æ‰˜ç®¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨å®ƒå¹¶ç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚

### SDKåˆå§‹åŒ–

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å®¢æˆ·ç«¯ï¼Œä»¥ä¾¿ä¸æ‰˜ç®¡çš„å›¾è¿›è¡Œé€šä¿¡ï¼š

=== "Python"

    ```python
    from langgraph_sdk import get_client
    client = get_client(url=<DEPLOYMENT_URL>)
    # ä½¿ç”¨åä¸º "agent" çš„å›¾
    assistant_id = "agent"
    thread = await client.threads.create()
    ```

=== "Javascript"

    ```js
    import { Client } from "@langchain/langgraph-sdk";

    const client = new Client({ apiUrl: <DEPLOYMENT_URL> });
    // ä½¿ç”¨åä¸º "agent" çš„å›¾
    const assistantId = "agent";
    const thread = await client.threads.create();
    ```

=== "CURL"

    ```bash
    curl --request POST \
      --url <DEPLOYMENT_URL>/threads \
      --header 'Content-Type: application/json' \
      --data '{}'
    ```

## ç­‰å¾…ç”¨æˆ·è¾“å…¥

### åˆå§‹è°ƒç”¨

ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸­æ–­`ask_human`èŠ‚ç‚¹æ¥è°ƒç”¨æˆ‘ä»¬çš„å›¾ï¼š

=== "Python"

    ```python
    input = {
        "messages": [
            {
                "role": "user",
                "content": "ä½¿ç”¨æœç´¢å·¥å…·è¯¢é—®ç”¨æˆ·ä»–ä»¬æ‰€åœ¨çš„ä½ç½®ï¼Œç„¶åæŸ¥æ‰¾é‚£é‡Œçš„å¤©æ°”",
            }
        ]
    }

    async for chunk in client.runs.stream(
        thread["thread_id"],
        assistant_id,
        input=input,
        stream_mode="updates",
        interrupt_before=["ask_human"],
    ):
        if chunk.data and chunk.event != "metadata": 
            print(chunk.data)
    ```
=== "Javascript"

    ```js
    const input = {
      messages: [
        {
          role: "human",
          content: "ä½¿ç”¨æœç´¢å·¥å…·è¯¢é—®ç”¨æˆ·ä»–ä»¬æ‰€åœ¨çš„ä½ç½®ï¼Œç„¶åæŸ¥æ‰¾é‚£é‡Œçš„å¤©æ°”"
        }
      ]
    };

    const streamResponse = client.runs.stream(
      thread["thread_id"],
      assistantId,
      {
        input: input,
        streamMode: "updates",
        interruptBefore: ["ask_human"]
      }
    );

    for await (const chunk of streamResponse) {
      if (chunk.data && chunk.event !== "metadata") {
        console.log(chunk.data);
      }
    }
    ```

=== "CURL"

    ```bash
    curl --request POST \
     --url <DEPLOYMENT_URL>/threads/<THREAD_ID>/runs/stream \
     --header 'Content-Type: application/json' \
     --data "{
       \"assistant_id\": \"agent\",
       \"input\": {\"messages\": [{\"role\": \"human\", \"content\": \"ä½¿ç”¨æœç´¢å·¥å…·è¯¢é—®ç”¨æˆ·ä»–ä»¬æ‰€åœ¨çš„ä½ç½®ï¼Œç„¶åæŸ¥æ‰¾é‚£é‡Œçš„å¤©æ°”\"}]},
       \"interrupt_before\": [\"ask_human\"],
       \"stream_mode\": [
         \"updates\"
       ]
     }" | \
     sed 's/\r$//' | \
     awk '
     /^event:/ {
         if (data_content != "" && event_type != "metadata") {
             print data_content "\n"
         }
         sub(/^event: /, "", $0)
         event_type = $0
         data_content = ""
     }
     /^data:/ {
         sub(/^data: /, "", $0)
         data_content = $0
     }
     END {
         if (data_content != "" && event_type != "metadata") {
             print data_content "\n"
         }
     }
     '
    ```
    
è¾“å‡º:

    {'agent': {'messages': [{'content': [{'text': "å½“ç„¶ï¼æˆ‘å°†ä½¿ç”¨AskHumanå‡½æ•°è¯¢é—®ç”¨æˆ·çš„ä½ç½®ï¼Œç„¶åä½¿ç”¨æœç´¢å‡½æ•°æŸ¥æ‰¾è¯¥ä½ç½®çš„å¤©æ°”ã€‚è®©æˆ‘ä»¬ä»è¯¢é—®ç”¨æˆ·çš„ä½ç½®å¼€å§‹ã€‚", 'type': 'text'}, {'id': 'toolu_01RFahzYPvnPWTb2USk2RdKR', 'input': {'question': 'æ‚¨å½“å‰æ‰€åœ¨çš„ä½ç½®æ˜¯å“ªé‡Œï¼Ÿ'}, 'name': 'AskHuman', 'type': 'tool_use'}], 'additional_kwargs': {}, 'response_metadata': {}, 'type': 'ai', 'name': None, 'id': 'run-a8422215-71d3-4093-afb4-9db141c94ddb', 'example': False, 'tool_calls': [{'name': 'AskHuman', 'args': {'question': 'æ‚¨å½“å‰æ‰€åœ¨çš„ä½ç½®æ˜¯å“ªé‡Œï¼Ÿ'}, 'id': 'toolu_01RFahzYPvnPWTb2USk2RdKR'}], 'invalid_tool_calls': [], 'usage_metadata': None}]}}


### å°†ç”¨æˆ·è¾“å…¥æ·»åŠ åˆ°çŠ¶æ€

æˆ‘ä»¬ç°åœ¨å¸Œæœ›ç”¨ç”¨æˆ·çš„å“åº”æ›´æ–°è¿™ä¸ªçº¿ç¨‹ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å¯åŠ¨å¦ä¸€ä¸ªè¿è¡Œã€‚

å› ä¸ºæˆ‘ä»¬å°†æ­¤è§†ä¸ºå·¥å…·è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†çŠ¶æ€æ›´æ–°ä¸ºå·¥å…·è°ƒç”¨çš„å“åº”ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥çŠ¶æ€ä»¥è·å–å·¥å…·è°ƒç”¨çš„IDã€‚


=== "Python"

    ```python
    state = await client.threads.get_state(thread['thread_id'])
    tool_call_id = state['values']['messages'][-1]['tool_calls'][0]['id']

    # æˆ‘ä»¬ç°åœ¨åˆ›å»ºå¸¦æœ‰IDå’Œæˆ‘ä»¬æƒ³è¦çš„å“åº”çš„å·¥å…·è°ƒç”¨
    tool_message = [{"tool_call_id": tool_call_id, "type": "tool", "content": "æ—§é‡‘å±±"}]

    await client.threads.update_state(thread['thread_id'], {"messages": tool_message}, as_node="ask_human")
    ```

=== "Javascript"

    ```js
    const state = await client.threads.getState(thread["thread_id"]);
    const toolCallId = state.values.messages[state.values.messages.length - 1].tool_calls[0].id;

    // æˆ‘ä»¬ç°åœ¨åˆ›å»ºå¸¦æœ‰IDå’Œæˆ‘ä»¬æƒ³è¦çš„å“åº”çš„å·¥å…·è°ƒç”¨
    const toolMessage = [
      {
        tool_call_id: toolCallId,
        type: "tool",
        content: "æ—§é‡‘å±±"
      }
    ];

    await client.threads.updateState(
      thread["thread_id"],
      { values: { messages: toolMessage } },
      { asNode: "ask_human" }
    );
    ```

=== "CURL"

    ```bash
    curl --request GET \
     --url <DEPLOYMENT_URL>/threads/<THREAD_ID>/state \
     | jq -r '.values.messages[-1].tool_calls[0].id' \
     | sh -c '
         TOOL_CALL_ID="$1"
         
         # æ„é€ JSONæœ‰æ•ˆè½½è·
         JSON_PAYLOAD=$(printf "{\"messages\": [{\"tool_call_id\": \"%s\", \"type\": \"tool\", \"content\": \"æ—§é‡‘å±±\"}], \"as_node\": \"ask_human\"}" "$TOOL_CALL_ID")
         
         # å‘é€æ›´æ–°åçš„çŠ¶æ€
         curl --request POST \
              --url <DEPLOYMENT_URL>/threads/<THREAD_ID>/state \
              --header "Content-Type: application/json" \
              --data "${JSON_PAYLOAD}"
     ' _ 
    ```

è¾“å‡º:

    {'configurable': {'thread_id': 'a9f322ae-4ed1-41ec-942b-38cb3d342c3a',
    'checkpoint_ns': '',
    'checkpoint_id': '1ef58e97-a623-63dd-8002-39a9a9b20be3'}}


### åœ¨æ¥æ”¶åˆ°ç”¨æˆ·è¾“å…¥åè°ƒç”¨

æˆ‘ä»¬ç°åœ¨å¯ä»¥å‘Šè¯‰ä»£ç†ç»§ç»­ã€‚æˆ‘ä»¬å¯ä»¥åªä¼ é€’Noneä½œä¸ºå›¾çš„è¾“å…¥ï¼Œå› ä¸ºä¸éœ€è¦é¢å¤–çš„è¾“å…¥ï¼š

=== "Python"

    ```python
    async for chunk in client.runs.stream(
        thread["thread_id"],
        assistant_id,
        input=None,
        stream_mode="updates",
    ):
        if chunk.data and chunk.event != "metadata": 
            print(chunk.data)
    ```
=== "Javascript"

    ```js
    const streamResponse = client.runs.stream(
      thread["thread_id"],
      assistantId,
      {
        input: null,
        streamMode: "updates"
      }
    );

    for await (const chunk of streamResponse) {
      if (chunk.data && chunk.event !== "metadata") {
        console.log(chunk.data);
      }
    }
    ```

=== "CURL"

    ```bash
    curl --request POST \                                                                             
     --url <DEPLOYMENT_URL>/threads/<THREAD_ID>/runs/stream \
     --header 'Content-Type: application/json' \
     --data "{
       \"assistant_id\": \"agent\",
       \"stream_mode\": [
         \"updates\"
       ]
     }"| \ 
     sed 's/\r$//' | \
     awk '
     /^event:/ {
         if (data_content != "" && event_type != "metadata") {
             print data_content "\n"
         }
         sub(/^event: /, "", $0)
         event_type = $0
         data_content = ""
     }
     /^data:/ {
         sub(/^data: /, "", $0)
         data_content = $0
     }
     END {
         if (data_content != "" && event_type != "metadata") {
             print data_content "\n"
         }
     }
     '
    ```

è¾“å‡º:

    {'agent': {'messages': [{'content': [{'text': "æ„Ÿè°¢æ‚¨å‘Šè¯‰æˆ‘æ‚¨åœ¨æ—§é‡‘å±±ã€‚ç°åœ¨ï¼Œæˆ‘å°†ä½¿ç”¨æœç´¢åŠŸèƒ½æŸ¥æ‰¾æ—§é‡‘å±±çš„å¤©æ°”ã€‚", 'type': 'text'}, {'id': 'toolu_01K57ofmgG2wyJ8tYJjbq5k7', 'input': {'query': 'æ—§é‡‘å±±å½“å‰å¤©æ°”'}, 'name': 'search', 'type': 'tool_use'}], 'additional_kwargs': {}, 'response_metadata': {}, 'type': 'ai', 'name': None, 'id': 'run-241baed7-db5e-44ce-ac3c-56431705c22b', 'example': False, 'tool_calls': [{'name': 'search', 'args': {'query': 'æ—§é‡‘å±±å½“å‰å¤©æ°”'}, 'id': 'toolu_01K57ofmgG2wyJ8tYJjbq5k7'}], 'invalid_tool_calls': [], 'usage_metadata': None}]}}
    {'action': {'messages': [{'content': '["æˆ‘æŸ¥æ‰¾äº†ï¼šæ—§é‡‘å±±å½“å‰å¤©æ°”ã€‚ç»“æœï¼šæ—§é‡‘å±±é˜³å…‰æ˜åªšï¼Œä½†å¦‚æœä½ æ˜¯åŒå­åº§ï¼Œä½ æœ€å¥½å°å¿ƒğŸ˜ˆã€‚"]', 'additional_kwargs': {}, 'response_metadata': {}, 'type': 'tool', 'name': 'search', 'id': '8b699b95-8546-4557-8e66-14ea71a15ed8', 'tool_call_id': 'toolu_01K57ofmgG2wyJ8tYJjbq5k7'}]}}
    {'agent': {'messages': [{'content': "æ ¹æ®æœç´¢ç»“æœï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›æ—§é‡‘å±±å½“å‰å¤©æ°”çš„ä¿¡æ¯ï¼š\n\næ—§é‡‘å±±çš„å¤©æ°”ç›®å‰æ˜¯æ™´å¤©ã€‚è¿™æ˜¯ä¸€ä¸ªç¾å¥½çš„æ—¥å­ï¼\n\nç„¶è€Œï¼Œæˆ‘æ³¨æ„åˆ°æœç´¢ç»“æœä¸­åŒ…æ‹¬äº†ä¸€ä¸ªå…³äºåŒå­åº§æ˜Ÿåº§çš„å¥‡æ€ªè¯„è®ºã€‚è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªç¬‘è¯æˆ–æœç´¢å¼•æ“æ·»åŠ çš„æ— å…³ä¿¡æ¯ã€‚è¦è·å–å‡†ç¡®å’Œè¯¦ç»†çš„å¤©æ°”ä¿¡æ¯ï¼Œæ‚¨å¯èƒ½éœ€è¦æŸ¥çœ‹æ—§é‡‘å±±çš„å¯é å¤©æ°”æœåŠ¡æˆ–åº”ç”¨ç¨‹åºã€‚\n\næ‚¨è¿˜æƒ³äº†è§£å…³äºå¤©æ°”æˆ–æ—§é‡‘å±±çš„å…¶ä»–ä¿¡æ¯å—ï¼Ÿ", 'additional_kwargs': {}, 'response_metadata': {}, 'type': 'ai', 'name': None, 'id': 'run-b4d7309f-f849-46aa-b6ef-475bcabd2be9', 'example': False, 'tool_calls': [], 'invalid_tool_calls': [], 'usage_metadata': None}]}}