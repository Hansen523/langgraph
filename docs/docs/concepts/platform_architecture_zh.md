# LangGraph平台架构

![](img/langgraph_platform_deployment_architecture.png)

## 我们如何使用Postgres

Postgres是LGP中所有用户和运行数据的持久层。它存储了检查点（更多信息请参见[此处](./persistence.md)）以及服务器资源（线程、运行、助手和定时任务）。

## 我们如何使用Redis

Redis在每个LGP部署中用作服务器和队列工作线程进行通信的方式，并用于存储临时元数据，更多详细信息如下。Redis中不存储任何用户/运行数据。

### 通信

LGP中的所有运行都由每个部署中的后台工作线程池执行。为了为这些运行启用某些功能（例如取消和输出流式传输），我们需要在服务器和处理特定运行的工作线程之间建立一个双向通信的通道。我们使用Redis来组织这种通信。

1. Redis列表用作一种机制，以便在新运行创建时立即唤醒工作线程。此列表中仅存储一个哨兵值，不存储实际的运行信息。然后，工作线程从Postgres中检索运行信息。
2. 使用Redis字符串和Redis PubSub通道的组合，服务器可以将运行取消请求传达给适当的工作线程。
3. 工作线程使用Redis PubSub通道在运行处理期间广播代理的流式输出。服务器中的任何打开`/stream`请求将订阅该通道，并在事件到达时将其转发到响应中。任何时候都不会在Redis中存储事件。

### 临时元数据

LGP部署中的运行可能会针对特定故障进行重试（目前仅针对运行期间遇到的临时Postgres错误）。为了限制重试次数（目前每次运行最多尝试3次），我们在运行被拾取时将尝试次数记录在Redis字符串中。除其ID外，此字符串不包含任何特定运行信息，并且会在短暂延迟后过期。