# LangGraph 平台：可扩展性与弹性

LangGraph 平台设计为能够随着您的工作负载水平扩展。每个服务实例都是无状态的，且不在内存中保留任何资源。该服务旨在优雅地处理新实例的添加或移除，包括硬关闭的情况。

## 服务器可扩展性

当您向服务中添加更多实例时，只要在它们前面放置了适当的负载均衡机制，它们将共享 HTTP 负载。在大多数部署模式中，我们会自动为服务配置负载均衡器。在“无控制平面自托管”模式下，您需要自行添加负载均衡器。由于实例是无状态的，任何负载均衡策略都适用，不需要也不推荐会话粘性。任何服务器实例都可以与任何队列实例通信（通过 Redis PubSub），这意味着取消或流式传输正在运行的请求可以由任何实例处理。

## 队列可扩展性

当您向服务中添加更多实例时，它们将线性增加运行吞吐量，因为每个实例都配置为处理一定数量的并发运行（默认为 10）。每次运行的尝试将由单个实例处理，通过 Postgres 的 MVCC 模型强制执行一次语义（有关崩溃弹性的详细信息，请参阅下文）。由于瞬时数据库错误而失败的尝试将重试最多 3 次。我们不使用长事务或锁，这使得我们能够更高效地利用 Postgres 资源。

## 弹性

当运行由队列实例处理时，该队列工作器将在 Redis 中记录一个定期的心跳时间戳。

当接收到优雅关闭请求（SIGINT）时，实例进入关闭模式，该模式将：

- 停止接受新的 HTTP 请求
- 给予任何正在运行的运行有限的秒数来完成（如果未完成，则将其放回队列）
- 停止实例从队列中获取更多运行

如果发生硬关闭，例如由于服务器崩溃或基础设施故障，任何正在运行的运行将由定期扫描任务拾取，该任务查找已超过其心跳窗口的正在运行的运行，并将其放回队列中由另一个实例拾取。

## Postgres 弹性

在我们管理 Postgres 数据库的部署模式中，我们有定期备份，持续复制的备用副本用于自动故障转移。根据需要，我们还可以设置读副本以及其他高级故障转移功能。

与 Postgres 的所有通信都实现了针对可重试错误的重试。如果 Postgres 暂时不可用，例如在数据库重启期间，大多数/所有流量应继续成功。Postgres 实例的长时间故障将把流量切换到故障转移副本。如果故障转移副本在主副本重新上线之前也发生故障，服务将变得不可用。

## Redis 弹性

所有需要持久存储的数据都存储在 Postgres 中，而不是 Redis 中。Redis 仅用于临时元数据和实例之间的通信。有关我们如何使用 Redis 的更多详细信息，请参阅[架构](./platform_architecture.md)页面。因此，我们对 Redis 没有持久性要求。

与 Redis 的所有通信都实现了针对可重试错误的重试。如果 Redis 暂时不可用，例如在数据库重启期间，大多数/所有流量应继续成功。Redis 的长时间故障将使 LGP 服务不可用。